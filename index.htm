<!DOCTYPE html>

<html>
  <head>
    <title>Simple</title>
    <script src='simple.js'></script>
    <script src='types.js'></script>
    <script src='vm.js'></script>
    <script src='compiler.js'></script>
    <script src='parser.js'></script>
    <script src='lexer.js'></script>
    
    <script>
      function init() {
        document.getElementById('run').addEventListener('click', function() {
          run();
        });
      }
    
      function run() {
        
        var code = document.getElementById('source').value;
        
        try {
          var lexer = simple.createLexer(code);
          var parser = simple.createParser(lexer);
          var ast = parser.parseTopLevel();
          var vm = simple.createVM();
          var compiler = new simple.Compiler(vm.env);
          var code = compiler.compile(ast);
        } catch (e) {
          if (e instanceof simple.ParseError) {
            console.log(e);
          } else {
            console.log("some other error!");
          }
        }
        
        vm.trace = function(vm, task, frame) {
          console.log("tracin'", task, frame);
          console.log(frame.dirtyLocals());
        }
        
        vm.env['random'] = function() {
          return Math.floor(Math.random() * 1000);
        }
        
        vm.env['delay'] = function(args, task, env, vm) {
          
          if (task.state == simple.TASK_RESUMED) {
            task.state = simple.TASK_RUNNABLE;
            return null;
          }
          
          task.state = simple.TASK_BLOCKED;
          setTimeout(function() { vm.resumeTask(task); }, args[0]);
          
        };
        
        vm.env['print'] = function(args) {
          console.log("VM say: ", args[0], args[1], args[2]);
        };
        
        vm.start();
        vm.spawn(code);
        
        // for (var i = 0; i < 20; ++i) {
        //   vm.spawn(code);
        // }
        // 
        // setTimeout(function() {
        //   for (var i = 0; i < 20; ++i) {
        //     vm.spawn(code);
        //   }
        // }, 10000);
        
        // var start = Date.now();
        // for (var i = 0; i < 100000; ++i) {
        //   
        // }
        // 
        // console.log(Date.now() - start);
        
      }
    </script>
  </head>
  <body onload='init()'>

<textarea id='source' style='font:12px Monospace; width: 400px; height: 400px'>
def fib(n)
{
  if n <= 0 {
    return 0
  } else if n <= 1 {
    return 1
  } else {
    return fib(n-2) + fib(n-1)
  }
}

-- a = 1
-- while a < 100 { a = a + 1 }

def add(l, r) {
  print "i'm in a function"
  return l + r
}

z = add 10, 20
print z

a = 35

if a < 30 {
  print "a is less than 30! - 1";
  print "a is less than 30! - 2"
  print "a is less than 30! - 3"
}
else if a < 40
{
  print "a is less than 40! - 1"
  print "a is less than 40! - 2"
  print "a is less than 40! - 3"
}
else
{
  print "a is >= 40"
}

trace; b = 20 * 30; c = b + 100

x = 0
while x < 10
{
  print x
  x = x + 1
  delay random()
}

a = 200
trace
trace

-- print(0x42 + c, 20, "foobar!")
print b, c, x
</textarea>
<br>
<input type='button' id='run' value='Run'>
  
  </body>
</html>