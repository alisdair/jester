<!DOCTYPE html>

<html>
  <head>
    <title>Simple</title>
    <script src='simple.js'></script>
    <script src='types.js'></script>
    <script src='vm.js'></script>
    <script src='compiler.js'></script>
    <script>
      function init() {
        
        var ast = [
          ['def', 'add', ['l', 'r'],
            [ ['return', ['+', ['ident', 'l'], ['ident', 'r']]]
            ]
          ],
          
          ['assign', ['ident', 'a'], 10],
          
          ['if',
            ['<', ['ident', 'a'], 30],
            [ ['call', ['ident', 'print'], ["a is less than 30! - 1"]],
              ['call', ['ident', 'print'], ["a is less than 30! - 2"]],
              ['call', ['ident', 'print'], ["a is less than 30! - 3"]]
            ],
            ['<', ['ident', 'a'], 40],
            [ ['call', ['ident', 'print'], ["a is less than 40! - 1"]],
              ['call', ['ident', 'print'], ["a is less than 40! - 2"]],
              ['call', ['ident', 'print'], ["a is less than 40! - 3"]]
            ],
            null,
            [ ['call', ['ident', 'print'], ["a is >= 40"]]
            ]
          ],
          
          ['trace'],
        
          ['assign', ['ident', 'b'], ['*', 20, 30]],
          ['assign', ['ident', 'c'], ['+', ['ident', 'b'], 100]],
          
          ['assign', ['ident', 'x'], 0],
          ['while',
            ['<', ['ident', 'x'], 10],
            [ ['call', ['ident', 'print'], [['ident', 'x']]],
              ['assign', ['ident', 'x'], ['+', ['ident', 'x'], 1]]
            ]
          ],
          
          ['assign', ['ident', 'a'], 200],
          ['trace'],
          
          ['call',
            ['ident', 'print'],
            [ ['call', ['ident', 'add'], [5, 6]]
            ]
          ],
          
          ['trace'],
          ['call', ['ident', 'print'], [['+', 50, ['ident', 'c']], 20, "foobar!"]],
          ['call', ['ident', 'print'], [['ident', 'b'], ['ident', 'c'], ['ident', 'x']]]
        ];
        
        var vm = simple.createVM();
        
        var compiler = new simple.Compiler(vm.env);
        var code = compiler.compile(ast);
        
        vm.trace = function(vm, task, frame) {
          console.log("tracin'", task, frame);
          console.log(frame.dirtyLocals());
        }
        
        vm.env['print'] = function(args) {
          console.log("VM say: ", args[0], args[1], args[2]);
        };
        
        vm.spawn(code);
        
        // var start = Date.now();
        // for (var i = 0; i < 100000; ++i) {
        //   
        // }
        // 
        // console.log(Date.now() - start);
        
        
        
      }
    </script>
  </head>
  <body onload='init()'>
  </body>
</html>